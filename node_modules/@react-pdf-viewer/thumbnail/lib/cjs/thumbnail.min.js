"use strict";var e=require("@react-pdf-viewer/core");function t(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var a=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,a.get?a:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var n=t(require("react")),a=function(){return a=Object.assign||function(e){for(var t,n=1,a=arguments.length;n<a;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},a.apply(this,arguments)},r=function(t){var a=t.doc,r=t.getPageIndex,i=t.renderSpinner,o=t.store,u=a.numPages,c=r?r({numPages:u}):0,s=Math.max(0,Math.min(c,u-1)),l=o.get("pagesRotation")||new Map,d=l.has(s)?l.get(s):0,g=n.useState(""),h=g[0],p=g[1],m=e.useIsMounted(),b=n.useRef(),f=n.useState(o.get("rotation")||0),v=f[0],P=f[1],_=n.useState(d),E=_[0],R=_[1],x=n.useState(!1),S=x[0],C=x[1],w=function(e){var t=e.has(s)?e.get(s):0;R(t)},I=function(e){P(e)},y=e.useIntersectionObserver({onVisibilityChanged:function(e){C(e.isVisible)}});return n.useEffect((function(){if(S){var t=y.current;t&&(p(""),e.getPage(a,s).then((function(e){var n=e.getViewport({scale:1}),a=(n.rotation+v+E)%360,r=Math.abs(v+E)%180==0,i=r?n.width:n.height,o=r?n.height:n.width,u=document.createElement("canvas"),c=u.getContext("2d",{alpha:!1}),s=t.clientWidth,l=t.clientHeight,d=Math.min(s/i,l/o),g=d*i,h=d*o;u.height=h,u.width=g,u.style.opacity="0";var f=e.getViewport({rotation:a,scale:d});b.current=e.render({canvasContext:c,viewport:f}),b.current.promise.then((function(){m.current&&p(u.toDataURL()),u.width=0,u.height=0}),(function(){}))})))}}),[E,S]),n.useEffect((function(){return o.subscribe("pagesRotation",w),o.subscribe("rotation",I),function(){o.unsubscribe("pagesRotation",w),o.unsubscribe("rotation",I)}}),[]),n.useEffect((function(){return function(){var e;null===(e=b.current)||void 0===e||e.cancel()}}),[]),n.createElement("div",{ref:y,className:"rpv-thumbnail__cover-inner","data-testid":"thumbnail__cover-inner"},h?n.createElement("img",{className:"rpv-thumbnail__cover-image","data-testid":"thumbnail__cover-image",src:h}):n.createElement("div",{className:"rpv-thumbnail__cover-loader","data-testid":"thumbnail__cover-loader"},i?i():n.createElement(e.Spinner,null)))},i=function(t){var a=t.getPageIndex,i=t.renderSpinner,o=t.store,u=n.useState(o.get("doc")),c=u[0],s=u[1],l=function(e){s(e)};return n.useEffect((function(){return o.subscribe("doc",l),function(){o.unsubscribe("doc",l)}}),[]),n.createElement("div",{className:"rpv-thumbnail__cover"},c?n.createElement(r,{doc:c,getPageIndex:a,renderSpinner:i,store:o}):n.createElement("div",{className:"rpv-thumbnail__cover-loader"},i?i():n.createElement(e.Spinner,null)))},o=function(){return n.createElement(e.Spinner,null)},u=n.createContext({renderSpinner:o}),c=function(t){var a=t.children,r=t.doc,i=e.useIsMounted(),o=n.useState({loading:!0,labels:[]}),u=o[0],c=o[1];return n.useEffect((function(){r.getPageLabels().then((function(e){i.current&&c({loading:!1,labels:e||[]})}))}),[r.loadingTask.docId]),u.loading?n.createElement(n.Fragment,null):a(u.labels)},s=function(t){var a=t.page,r=t.pageHeight,i=t.pageIndex,o=t.pageWidth,c=t.rotation,s=t.thumbnailHeight,l=t.thumbnailWidth,d=t.onRenderCompleted,g=n.useContext(e.LocalizationContext).l10n,h=n.useRef(),p=n.useState(""),m=p[0],b=p[1],f=g&&g.thumbnail?g.thumbnail.thumbnailLabel:"Thumbnail of page {{pageIndex}}";return n.useEffect((function(){var e=h.current;e&&e.cancel();var t=document.createElement("canvas"),n=t.getContext("2d",{alpha:!1}),u=l,s=u/(o/r),g=u/o;t.height=s,t.width=u,t.style.height="".concat(s,"px"),t.style.width="".concat(u,"px");var p=a.getViewport({rotation:c,scale:g});return h.current=a.render({canvasContext:n,viewport:p}),h.current.promise.then((function(){b(t.toDataURL()),d(i)}),(function(){d(i)})),function(){var e;null===(e=h.current)||void 0===e||e.cancel()}}),[c]),m?n.createElement("img",{"aria-label":f.replace("{{pageIndex}}","".concat(i+1)),src:m,height:"".concat(s,"px"),width:"".concat(l,"px")}):n.useContext(u).renderSpinner()},l=function(t){var a=t.doc,r=t.pageHeight,i=t.pageIndex,o=t.pageRotation,c=t.pageWidth,l=t.rotation,d=t.shouldRender,g=t.thumbnailWidth,h=t.onRenderCompleted,p=t.onVisibilityChanged,m=e.useIsMounted(),b=n.useState({height:r,page:null,viewportRotation:0,width:c}),f=b[0],v=b[1],P=f.page,_=f.height,E=f.width,R=E/_,x=Math.abs(l+o)%180==0,S=x?g:g/R,C=x?g/R:g;n.useEffect((function(){d&&e.getPage(a,i).then((function(e){var t=e.getViewport({scale:1});m.current&&v({height:t.height,page:e,viewportRotation:t.rotation,width:t.width})}))}),[d]);var w=(f.viewportRotation+l+o)%360,I=e.useIntersectionObserver({onVisibilityChanged:function(e){p(i,e)}});return n.createElement("div",{className:"rpv-thumbnail__container","data-testid":"thumbnail__container-".concat(i),ref:I,style:{height:"".concat(C,"px"),width:"".concat(S,"px")}},P?n.createElement(s,{page:P,pageHeight:x?_:E,pageIndex:i,pageWidth:x?E:_,rotation:w,thumbnailHeight:C,thumbnailWidth:S,onRenderCompleted:h}):n.useContext(u).renderSpinner())},d=function(t){var a=t.currentPage,r=t.doc,i=t.labels,o=t.pagesRotation,u=t.pageHeight,c=t.pageWidth,s=t.renderCurrentPageLabel,d=t.renderThumbnailItem,g=t.rotatedPage,h=t.rotation,p=t.thumbnailWidth,m=t.onJumpToPage,b=t.onRotatePage,f=r.numPages,v=r.loadingTask.docId,P=n.useRef(null),_=n.useRef([]),E=n.useState(a),R=E[0],x=E[1],S=n.useContext(e.ThemeContext).direction===e.TextDirection.RightToLeft,C=n.useState(-1),w=C[0],I=C[1],y=e.useIsMounted(),T=n.useRef(!1),W=e.useRenderQueue({doc:r}),k=n.useMemo((function(){return Array(f).fill(0).map((function(e,t){return t}))}),[v]),L=function(){if(P.current){var e=_.current,t=R+1;t<e.length&&(R>=0&&e[R].setAttribute("tabindex","-1"),x(t))}},H=function(){if(P.current){var e=_.current,t=R-1;t>=0&&(R>=0&&e[R].setAttribute("tabindex","-1"),x(t))}},M=function(){R>=0&&R<f&&m(R)};e.useIsomorphicLayoutEffect((function(){var e=P.current;e&&(_.current=Array.from(e.querySelectorAll(".rpv-thumbnail__item")))}),[]),n.useEffect((function(){var e=_.current;if(!(0===e.length||R<0||R>e.length)){var t=e[R];t.setAttribute("tabindex","0"),t.focus()}}),[R]),e.useIsomorphicLayoutEffect((function(){var e=P.current;if(e){var t=e.children;a<t.length&&function(e,t){var n=e.getBoundingClientRect().top-t.getBoundingClientRect().top,a=e.clientHeight,r=t.clientHeight;n<0?t.scrollTop+=n:n+a<=r||(t.scrollTop+=n+a-r)}(t.item(a),e)}}),[a]);var N=n.useCallback((function(e){y.current&&(W.markRendered(e),T.current=!1,V())}),[v]),O=n.useCallback((function(e,t){t.isVisible?W.setVisibility(e,t.ratio):W.setOutOfRange(e),V()}),[v]),V=n.useCallback((function(){if(!T.current){var e=W.getHighestPriorityPage();e>-1&&(W.markRendering(e),T.current=!0,I(e))}}),[v]);return n.useEffect((function(){g>=0&&(W.markRendering(g),T.current=!0,I(g))}),[v,g]),n.createElement("div",{ref:P,"data-testid":"thumbnail__list",className:e.classNames({"rpv-thumbnail__list":!0,"rpv-thumbnail__list--rtl":S}),onKeyDown:function(e){switch(e.key){case"ArrowDown":L();break;case"ArrowUp":H();break;case"Enter":M()}}},k.map((function(t){var g="".concat(r.loadingTask.docId,"___").concat(t),v=i.length===f?i[t]:"".concat(t+1),P=s?s({currentPage:a,pageIndex:t,numPages:f,pageLabel:v}):v,_=o.has(t)?o.get(t):0,E=n.createElement(l,{doc:r,pageHeight:u,pageIndex:t,pageRotation:_,pageWidth:c,rotation:h,shouldRender:w===t,thumbnailWidth:p,onRenderCompleted:N,onVisibilityChanged:O});return d?d({currentPage:a,key:g,numPages:f,pageIndex:t,renderPageLabel:n.createElement(n.Fragment,null,P),renderPageThumbnail:E,onJumpToPage:function(){return m(t)},onRotatePage:function(e){return b(t,e)}}):n.createElement("div",{key:g},n.createElement("div",{className:e.classNames({"rpv-thumbnail__item":!0,"rpv-thumbnail__item--selected":a===t}),role:"button",tabIndex:a===t?0:-1,onClick:function(){return m(t)}},E),n.createElement("div",{"data-testid":"thumbnail__label-".concat(t),className:"rpv-thumbnail__label"},P))})))},g=function(t){var a=t.renderCurrentPageLabel,r=t.renderThumbnailItem,i=t.store,o=t.thumbnailWidth,s=n.useState(i.get("doc")),l=s[0],g=s[1],h=n.useState(i.get("currentPage")||0),p=h[0],m=h[1],b=n.useState(i.get("pageHeight")||0),f=b[0],v=b[1],P=n.useState(i.get("pageWidth")||0),_=P[0],E=P[1],R=n.useState(i.get("rotation")||0),x=R[0],S=R[1],C=n.useState(i.get("pagesRotation")||new Map),w=C[0],I=C[1],y=n.useState(i.get("rotatedPage")||-1),T=y[0],W=y[1],k=function(e){m(e)},L=function(e){g(e)},H=function(e){v(e)},M=function(e){E(e)},N=function(e){S(e)},O=function(e){I(e)},V=function(e){W(e)},j=function(e){var t=i.get("jumpToPage");t&&t(e)},A=function(e,t){i.get("rotatePage")(e,t)};return n.useEffect((function(){return i.subscribe("doc",L),i.subscribe("pageHeight",H),i.subscribe("pageWidth",M),i.subscribe("rotatedPage",V),i.subscribe("rotation",N),i.subscribe("pagesRotation",O),function(){i.unsubscribe("doc",L),i.unsubscribe("pageHeight",H),i.unsubscribe("pageWidth",M),i.unsubscribe("rotatedPage",V),i.unsubscribe("rotation",N),i.unsubscribe("pagesRotation",O)}}),[]),e.useIsomorphicLayoutEffect((function(){return i.subscribe("currentPage",k),function(){i.unsubscribe("currentPage",k)}}),[]),l?n.createElement(e.LazyRender,{testId:"thumbnail__list-container",attrs:{className:"rpv-thumbnail__list-container"}},n.createElement(c,{doc:l},(function(e){return n.createElement(d,{currentPage:p,doc:l,labels:e,pagesRotation:w,pageHeight:f,pageWidth:_,renderCurrentPageLabel:a,renderThumbnailItem:r,rotatedPage:T,rotation:x,thumbnailWidth:o,onJumpToPage:j,onRotatePage:A})}))):n.createElement("div",{"data-testid":"thumbnail-list__loader",className:"rpv-thumbnail__loader"},n.useContext(u).renderSpinner())};exports.thumbnailPlugin=function(t){var r=n.useMemo((function(){return e.createStore({rotatePage:function(){}})}),[]),c=n.useState(""),s=c[0],l=c[1];return{install:function(e){r.update("jumpToPage",e.jumpToPage),r.update("rotatePage",e.rotatePage)},onDocumentLoad:function(e){l(e.doc.loadingTask.docId),r.update("doc",e.doc)},onViewerStateChange:function(e){return r.update("currentPage",e.pageIndex),r.update("pagesRotation",e.pagesRotation),r.update("pageHeight",e.pageHeight),r.update("pageWidth",e.pageWidth),r.update("rotation",e.rotation),r.update("rotatedPage",e.rotatedPage),e},Cover:function(e){return n.createElement(i,a({},e,{renderSpinner:null==t?void 0:t.renderSpinner,store:r}))},Thumbnails:n.useCallback((function(e){return n.createElement(u.Provider,{value:{renderSpinner:(null==t?void 0:t.renderSpinner)||o}},n.createElement(g,{renderCurrentPageLabel:null==t?void 0:t.renderCurrentPageLabel,renderThumbnailItem:null==e?void 0:e.renderThumbnailItem,store:r,thumbnailWidth:(null==t?void 0:t.thumbnailWidth)||100}))}),[s])}};
